# Исправление ошибки "empty message text"

## Проблема

При отправке изображения без текста в чат возникала ошибка:
```
YandexGPT API error: 400 "empty message text"
```

## Причина

1. **Отсутствие fallback при неудачном анализе изображения**: Если Vision API не возвращал описание или возвращал ошибку, `enrichedContent` оставался пустым.

2. **Ошибка классификации в Vision API**: В некоторых случаях Vision API возвращает ошибку `"Unsupported classification model"`, что приводило к отсутствию описания изображения.

3. **Недостаточная обработка edge cases**: Не было обработки случая, когда и текст пустой, и анализ изображения не дал результатов.

## Решение

### 1. Улучшена обработка в `hooks/useChat.ts`

#### Изменения:
- Добавлен явный fallback для изображений, если анализ не удался
- Добавлена фильтрация пустых описаний файлов
- Добавлена обработка случая, когда нет ни контента, ни валидных описаний

```typescript
// Fallback for images if analysis fails
return `[Изображение: ${file.name} - изображение прикреплено, но анализ недоступен]`;

// Filter out any undefined/null values
const validDescriptions = fileDescriptions.filter(desc => desc && desc.trim());

// If no content and no valid descriptions, add a default message
if (!content.trim()) {
  enrichedContent = '[Прикреплены файлы, но их содержимое не может быть проанализировано]';
}
```

### 2. Улучшена обработка в `app/api/analyze-image/route.ts`

#### Изменения:
- Добавлена проверка на наличие ошибки в результате классификации
- Изменен порядок формирования описания (сначала текст, потом классификация)
- Добавлены множественные fallback на разных уровнях
- Улучшено логирование некритичных ошибок

```typescript
// Extract classification (may not always be available)
if (result.results?.classification && !result.error) {
  // ... extract classification
} else if (result.error) {
  console.log('Classification error (non-critical):', result.error.message);
}

// Always provide some description
if (extractedText) {
  descriptionParts.push(`Текст на изображении: "${extractedText}"`);
}

if (imageClassification) {
  descriptionParts.push(`Содержимое изображения: ${imageClassification}`);
} else if (!extractedText) {
  descriptionParts.push('Изображение содержит визуальную информацию');
}

fullDescription = descriptionParts.join('. ') || 'Изображение загружено';
```

## Результат

Теперь система корректно обрабатывает следующие сценарии:

### ✅ Сценарий 1: Успешный анализ
- OCR извлек текст: "Деплою будущее the Future..."
- Классификация недоступна
- **Результат**: `Текст на изображении: "Деплою будущее the Future..."`

### ✅ Сценарий 2: Только классификация
- OCR не нашел текст
- Классификация: "photo (95%), document (80%)"
- **Результат**: `Содержимое изображения: photo (95%), document (80%)`

### ✅ Сценарий 3: Полный анализ
- OCR извлек текст: "Hello World"
- Классификация: "code (90%)"
- **Результат**: `Текст на изображении: "Hello World". Содержимое изображения: code (90%)`

### ✅ Сценарий 4: Неудачный анализ
- OCR не нашел текст
- Классификация недоступна
- **Результат**: `Изображение содержит визуальную информацию`

### ✅ Сценарий 5: Ошибка Vision API
- Vision API вернул ошибку
- **Результат**: `[Изображение: file.jpg - изображение прикреплено, но анализ недоступен]`

### ✅ Сценарий 6: Полная неудача
- Все файлы не удалось проанализировать
- Нет текста от пользователя
- **Результат**: `[Прикреплены файлы, но их содержимое не может быть проанализировано]`

## Тестирование

### Как проверить исправление:

1. **Тест 1: Изображение с текстом**
   ```
   Действие: Прикрепить скриншот с текстом, отправить без комментария
   Ожидание: Сообщение отправлено, YandexGPT видит текст с изображения
   ```

2. **Тест 2: Изображение без текста**
   ```
   Действие: Прикрепить фото природы, отправить без комментария
   Ожидание: Сообщение отправлено с базовым описанием
   ```

3. **Тест 3: Проверка логов**
   ```
   Проверить: В логах должно быть "Classification error (non-critical)" вместо краша
   ```

## Известные ограничения

1. **Классификация изображений**: В некоторых Yandex Cloud каталогах модель классификации недоступна. Это не критично, так как OCR продолжает работать.

2. **Fallback описания**: Когда анализ полностью не удается, YandexGPT получает только информацию о том, что изображение прикреплено, без деталей о содержимом.

## Дальнейшие улучшения

Возможные улучшения в будущем:

1. **Кэширование результатов анализа**: Сохранять результаты Vision API в базе данных, чтобы не анализировать одно и то же изображение повторно.

2. **Альтернативные сервисы**: Добавить fallback на другие сервисы анализа изображений (OpenAI Vision, Google Cloud Vision) если Yandex Vision недоступен.

3. **Оптимизация изображений**: Сжимать изображения перед отправкой в Vision API для ускорения обработки.

4. **Прогресс-бар анализа**: Показывать пользователю прогресс анализа изображения.

## Связанные файлы

- `/hooks/useChat.ts` - основная логика обработки
- `/app/api/analyze-image/route.ts` - API endpoint для Vision API
- `/docs/YANDEX_VISION_INTEGRATION.md` - полная документация

## Версия

- **Исправление**: 10 октября 2025
- **Версия**: 1.0.1

