# Исправление циклических запросов на странице профиля

## Проблема

При переходе на страницу `/auth/profile` наблюдались циклические запросы в терминале. Страница постоянно перезапрашивала данные с сервера, что приводило к избыточной нагрузке и неэффективному использованию ресурсов.

## Причина

Проблема заключалась в неправильном управлении зависимостями в `useEffect` хуках. В нескольких местах функции из внешних хуков (например, `add` из `useToaster` и `toast` из `useToast`) были включены в массив зависимостей `useEffect`. Эти функции могут пересоздаваться при каждом рендере, что приводило к повторному выполнению эффектов и новым запросам к API.

### Проблемные места:

1. **`app/components/profile/ApiKeysManager.tsx`**
   - `fetchApiKeys` был обернут в `useCallback` с зависимостью `[toast]`
   - `useEffect` зависел от `fetchApiKeys`, создавая цикл

2. **`app/auth/profile/hooks/useProfile.ts`**
   - `useEffect` включал `add` (из `useToaster`) в зависимости
   - Функция `add` пересоздавалась, вызывая повторный запрос профиля

3. **`app/auth/profile/hooks/useSubscription.ts`**
   - Аналогичная проблема с `add` в зависимостях `useEffect`
   - Вызывало повторные запросы к таблице подписок

## Решение

Для устранения проблемы были внесены следующие изменения:

### 1. ApiKeysManager.tsx

```typescript
// Было:
useEffect(() => {
  fetchApiKeys();
}, [fetchApiKeys]);

// Стало:
useEffect(() => {
  fetchApiKeys();
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, []);
```

### 2. useProfile.ts

```typescript
// Было:
useEffect(() => {
  fetchUserProfile();
}, [mounted, userId, add]);

// Стало:
useEffect(() => {
  fetchUserProfile();
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [mounted, userId]);
```

### 3. useSubscription.ts

```typescript
// Было:
useEffect(() => {
  fetchSubscription();
}, [mounted, userId, userEmail, add]);

// Стало:
useEffect(() => {
  fetchSubscription();
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [mounted, userId, userEmail]);
```

## Объяснение

Функции `toast` и `add` используются внутри эффектов для отображения уведомлений об ошибках, но они не должны вызывать повторное выполнение эффектов. Это "стабильные" функции из контекста, которые не меняют логику загрузки данных.

Мы исключили эти функции из массива зависимостей и добавили комментарий `eslint-disable-next-line` для отключения предупреждения ESLint о exhaustive-deps. Это безопасно, потому что:

1. Функции уведомлений (`toast`, `add`) не влияют на результат запроса
2. Они используются только для отображения результата операции
3. Основные зависимости (`mounted`, `userId`, `userEmail`) остались и корректно контролируют выполнение эффектов

## Результат

После внесения изменений:
- ✅ Устранены циклические запросы к API
- ✅ Страница `/auth/profile` загружается один раз при монтировании
- ✅ Уведомления об ошибках продолжают работать корректно
- ✅ Снижена нагрузка на сервер и клиент
- ✅ Улучшена производительность приложения

## Превентивные меры

Для предотвращения подобных проблем в будущем:

1. **Проверяйте зависимости useEffect**: Не все функции должны быть в массиве зависимостей
2. **Используйте useCallback осторожно**: Убедитесь, что зависимости callback'а действительно необходимы
3. **Следите за стабильностью функций**: Функции из контекста обычно стабильны и не требуют включения в зависимости
4. **Тестируйте повторные рендеры**: Используйте React DevTools Profiler для отслеживания избыточных рендеров
5. **Логируйте вызовы API**: Добавьте консольные логи для отслеживания частоты запросов во время разработки

## Связанные файлы

- `app/components/profile/ApiKeysManager.tsx`
- `app/auth/profile/hooks/useProfile.ts`
- `app/auth/profile/hooks/useSubscription.ts`
- `app/auth/profile/page.tsx`

## Дата исправления

9 октября 2025

