# Исправление проблемы доступа к Broadcasts

## Проблема
При попытке зайти на страницу `/broadcasts` появляется ошибка о недостаточных правах, даже если пользователь авторизован как администратор.

## Причина
Проблема связана с Row Level Security (RLS) политиками в таблице `sent_mails`. RLS политики проверяют роль пользователя через подзапрос к таблице `profiles`, но этот подзапрос может работать некорректно в некоторых контекстах.

## Решение

### Шаг 1: Проверка текущего состояния

1. Откройте страницу `/debug` в браузере
2. Проверьте информацию о пользователе и профиле
3. Убедитесь, что:
   - Вы авторизованы (есть User ID и Email)
   - У вас есть профиль в таблице `profiles`
   - У профиля установлена роль (role)

### Шаг 2: Установка роли администратора

Если у вас нет роли или она не установлена как `admin` или `editor`:

1. На странице `/debug` нажмите кнопку **"Set Admin Role"**
2. Дождитесь успешного выполнения операции
3. Проверьте, что роль обновилась в разделе "Profile Information"

### Шаг 3: Исправление RLS политик (если проблема сохраняется)

Если после установки роли проблема не решилась, нужно обновить RLS политики в базе данных:

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Выполните миграцию из файла `migrations/fix_broadcasts_rls_policies.sql`

Эта миграция:
- Создаёт функцию `has_broadcast_access()` для проверки прав доступа
- Пересоздаёт RLS политики с использованием этой функции
- Делает проверку прав более надёжной и быстрой

### Шаг 4: Тестирование доступа

1. На странице `/debug` нажмите кнопку **"Test Broadcasts Access"**
2. Если тест прошёл успешно, перейдите на страницу `/broadcasts`
3. Вы должны увидеть список рассылок (или пустую страницу, если рассылок ещё нет)

## Диагностика проблем

### Ошибка "User profile not found or missing role"

**Причина:** У пользователя нет записи в таблице `profiles` или у записи не установлена роль.

**Решение:** Используйте кнопку "Set Admin Role" на странице `/debug`.

### Ошибка "Permission denied for sent_mails table"

**Причина:** RLS политики блокируют доступ к таблице.

**Решение:** 
1. Выполните миграцию `fix_broadcasts_rls_policies.sql`
2. Убедитесь, что у вашего пользователя роль `admin` или `editor`

### Ошибка "Invalid Refresh Token: Refresh Token Not Found"

**Причина:** Refresh token в cookie поврежден или отсутствует. Это может произойти при обновлении приложения или изменении конфигурации Supabase.

**Решение:**
1. **Быстрое решение:** Очистите cookies и перелогиньтесь:
   - Откройте DevTools (F12) → Application → Cookies
   - Удалите cookie `sb-rajacaayhzgjoitquqvt-auth-token`
   - Перейдите на `/auth` и войдите заново

2. **Автоматическое решение:** Обновленный код теперь автоматически использует `access_token` напрямую из cookie, минуя проблемный `refresh_token`. Просто обновите страницу.

### Ошибка "token is expired" или "invalid JWT"

**Причина:** Access token истек. Токены Supabase имеют ограниченный срок действия (обычно 1 час).

**Решение:**
1. **Автоматическое решение:** Система автоматически определит истекший токен и перенаправит вас на страницу входа через 2 секунды
2. **Ручное решение:** 
   - Перейдите на `/auth` и войдите заново
   - После входа токен будет обновлен автоматически
3. **Для разработки:** Если проблема возникает часто, убедитесь, что в Supabase настроено автоматическое обновление токенов

### Ошибка "The sent_mails table does not exist"

**Причина:** Таблица `sent_mails` не создана в базе данных.

**Решение:** Выполните миграцию `create_sent_mails_table.sql` из папки `migrations`.

## Структура проверки прав

```
Пользователь → auth.uid()
     ↓
Таблица profiles → role
     ↓
Функция has_broadcast_access()
     ↓
RLS политики → разрешение/запрет доступа
```

## Необходимые роли

Для доступа к функционалу broadcasts требуется одна из следующих ролей:
- `admin` - полный доступ ко всем функциям
- `editor` - доступ к созданию и управлению рассылками

## Дополнительные инструменты

### Debug страница (`/debug`)

Предоставляет следующие инструменты:
- Просмотр информации о текущем пользователе
- Просмотр информации о профиле и роли
- Установка роли администратора
- Тестирование доступа к API broadcasts

### API эндпоинты

- `GET /api/debug/set-admin-role` - установка роли администратора
- `GET /api/broadcasts` - получение списка рассылок (требует авторизацию)

## Проверка в консоли браузера

Откройте консоль браузера (F12) и проверьте логи:
- Ошибки аутентификации будут отображаться с префиксом "Auth middleware"
- Ошибки API будут содержать детальную информацию о проблеме
- Успешные запросы будут показывать статус 200

## Миграции для выполнения (в порядке приоритета)

1. `create_sent_mails_table.sql` - создание основной таблицы
2. `add_content_html_to_sent_mails.sql` - добавление поля для HTML контента
3. `add_delete_policy_sent_mails.sql` - добавление политики удаления
4. `fix_broadcasts_rls_policies.sql` - исправление RLS политик (новая)

## Контакты для поддержки

Если проблема не решается:
1. Проверьте логи в консоли браузера
2. Проверьте логи сервера Next.js
3. Проверьте логи Supabase в Dashboard → Logs
