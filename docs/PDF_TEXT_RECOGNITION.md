# Распознавание текста в PDF и Word документах

## Проблема

При загрузке PDF и Word файлов в чат, текст из них не распознавался. Система просто добавляла метку `[Файл: название.pdf (application/pdf)]` без извлечения содержимого.

## Причина

В хуке `useChat.ts` обработка файлов делилась на две категории:
1. **Изображения** (`image/*`) - отправлялись на анализ через `/api/analyze-image` с использованием Yandex Vision API
2. **Все остальные файлы** (включая PDF) - просто добавлялась текстовая метка без анализа

Yandex Vision API работает только с изображениями и не может обрабатывать PDF документы.

## Решение

### 1. Установлены зависимости

```bash
npm install pdf-parse@1.1.1  # Для PDF файлов
npm install mammoth           # Для Word .docx файлов
```

- `pdf-parse` (версия 1.1.1) - извлекает текст из PDF файлов
- `mammoth` - извлекает текст из Word .docx файлов

### 2. Созданы новые API эндпоинты

#### `/api/analyze-pdf`

**Файл:** `app/api/analyze-pdf/route.ts`

**Функциональность:**
- Принимает URL PDF файла и его имя
- Загружает PDF файл по URL
- Извлекает текст из всех страниц документа (используя pdf-parse 1.1.1)
- Ограничивает текст до 3000 символов (чтобы избежать переполнения токенов)
- Возвращает извлеченный текст, количество страниц и полное описание

**Формат ответа:**
```json
{
  "text": "Извлеченный текст...",
  "pageCount": 5,
  "description": "PDF документ \"название.pdf\" (5 стр.):\n\nИзвлеченный текст...",
  "success": true
}
```

#### `/api/analyze-document`

**Файл:** `app/api/analyze-document/route.ts`

**Функциональность:**
- Принимает URL Word документа (.docx), его имя и тип файла
- Загружает документ по URL
- Извлекает текст из документа (используя mammoth)
- Ограничивает текст до 3000 символов
- Возвращает извлеченный текст и полное описание
- **Не поддерживает** старый формат .doc (только .docx)

**Формат ответа:**
```json
{
  "text": "Извлеченный текст...",
  "description": "Word документ \"название.docx\":\n\nИзвлеченный текст...",
  "success": true
}
```

### 3. Обновлен хук `useChat.ts`

Добавлена обработка PDF и Word файлов в функции `sendMessage`:

```typescript
// Check if it's a PDF
if (file.type === 'application/pdf') {
  try {
    // Call PDF analysis API
    const { data: { session } } = await supabase.auth.getSession();
    const response = await fetch('/api/analyze-pdf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${session?.access_token}`,
      },
      body: JSON.stringify({
        pdfUrl: file.url,
        fileName: file.name,
      }),
    });
    
    if (response.ok) {
      const analysis = await response.json();
      if (analysis.success && analysis.description) {
        return analysis.description;
      }
    }
  } catch (error) {
    console.error('Error analyzing PDF:', error);
  }
  // Fallback if analysis fails
  return `[Файл: ${file.name} - PDF документ прикреплен, но анализ текста недоступен]`;
}
```

## Как это работает

1. Пользователь прикрепляет PDF файл к сообщению в чате
2. Файл загружается в Yandex Cloud Storage
3. При отправке сообщения:
   - Система определяет, что это PDF файл
   - Вызывается API `/api/analyze-pdf` с URL файла
   - API скачивает файл и извлекает текст
   - Извлеченный текст добавляется к сообщению пользователя
4. YandexGPT получает сообщение с полным текстом из PDF
5. AI может анализировать содержимое документа и отвечать на вопросы

## Ограничения

- Текст ограничен 3000 символами для экономии токенов
- PDF с только изображениями (без текстового слоя) не будут распознаны
- Для сканированных документов потребуется OCR (можно добавить Yandex Vision API)

## Примеры использования

**До исправления:**
```
Пользователь: На сколько увеличится моя зарплата? [Прикреплен: doc.pdf]
Контекст для AI: "На сколько увеличится моя зарплата? [Файл: doc.pdf (application/pdf)]"
AI: Для ответа мне нужно ознакомиться с содержанием файла...
```

**После исправления:**
```
Пользователь: На сколько увеличится моя зарплата? [Прикреплен: doc.pdf]
Контекст для AI: "На сколько увеличится моя зарплата?

PDF документ "doc.pdf" (2 стр.):

Уведомление о повышении заработной платы
С 1 января 2025 года ваша зарплата составит 150,000 руб.
Текущая зарплата: 120,000 руб..."

AI: Согласно документу, ваша зарплата увеличится на 30,000 рублей...
```

## Технические детали

### Использование динамического импорта

Библиотека `pdf-parse` имеет проблемы с ESM импортами в Next.js, поэтому используется динамический импорт:

```typescript
const getPdfParse = async () => {
  // @ts-ignore - pdf-parse has issues with ESM imports
  const pdfParse = (await import('pdf-parse')).default;
  return pdfParse;
};
```

### Аутентификация

API эндпоинт защищен аутентификацией Supabase:
- Требуется Authorization заголовок с токеном доступа
- Проверяется валидность токена перед обработкой

## Дата создания

10 октября 2025

## Связанные файлы

- `app/api/analyze-pdf/route.ts` - новый API эндпоинт
- `hooks/useChat.ts` - обновленный хук с обработкой PDF
- `package.json` - добавлены зависимости pdf-parse

