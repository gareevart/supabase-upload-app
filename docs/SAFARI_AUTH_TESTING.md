# Инструкция по тестированию исправления аутентификации в Safari

## Что было исправлено

Устранена ошибка `AuthError` / `AuthApiError`, которая возникала в Safari при работе с аутентификацией Supabase.

## Как протестировать

### 1. Базовая аутентификация

#### Тест 1: Вход через Email/Password
1. Откройте Safari
2. Перейдите на `http://localhost:3000/auth`
3. Войдите используя email и пароль
4. ✅ Проверьте, что вход прошел успешно и вас перенаправило на `/auth/profile`
5. ✅ Проверьте, что в консоли Safari нет ошибок `AuthError`

#### Тест 2: OAuth-авторизация (Google, Yandex и т.д.)
1. Откройте Safari
2. Перейдите на `http://localhost:3000/auth`
3. Нажмите кнопку входа через OAuth провайдер
4. Пройдите авторизацию
5. ✅ Проверьте, что колбэк обработан корректно
6. ✅ Проверьте, что в консоли Safari нет ошибок

### 2. Сохранение сессии

#### Тест 3: Перезагрузка страницы
1. Войдите в приложение в Safari
2. Перезагрузите страницу (Cmd+R)
3. ✅ Проверьте, что вы остались авторизованы
4. ✅ Проверьте, что не было повторного редиректа на `/auth`

#### Тест 4: Переход между страницами
1. Войдите в приложение
2. Перейдите на разные страницы: `/blog`, `/chat`, `/profile`
3. ✅ Проверьте, что сессия сохраняется
4. ✅ Проверьте, что нет ошибок в консоли

### 3. Выход из системы

#### Тест 5: Logout
1. Войдите в приложение
2. Нажмите кнопку выхода
3. ✅ Проверьте, что вас перенаправило на `/auth`
4. ✅ Проверьте, что localStorage очищен (DevTools → Storage → Local Storage)
5. ✅ Проверьте, что повторный доступ к защищенным страницам требует авторизации

### 4. Приватный режим Safari

#### Тест 6: Private Browsing
1. Откройте новое приватное окно Safari (Shift+Cmd+N)
2. Перейдите на `http://localhost:3000/auth`
3. Войдите в приложение
4. ✅ Проверьте, что аутентификация работает в приватном режиме
5. ✅ Проверьте, что нет ошибок в консоли

### 5. Автоматическое обновление токена

#### Тест 7: Token Refresh
1. Войдите в приложение
2. Откройте DevTools → Console
3. Подождите несколько минут (токен обновляется автоматически)
4. ✅ Проверьте в консоли сообщения о успешном обновлении токена
5. ✅ Проверьте, что приложение продолжает работать без перезагрузки

## Проверка в DevTools

### Что смотреть в Console
```javascript
// НЕ должно быть таких ошибок:
❌ AuthError
❌ AuthApiError
❌ Session error
❌ Error getting initial user

// Должны быть такие сообщения (при необходимости):
✅ OAuth parameters detected in URL
✅ User authenticated successfully
✅ Setting session with tokens
```

### Что смотреть в Storage
1. Откройте DevTools → Storage → Local Storage
2. Должны быть ключи от Supabase:
   - `sb-[project-id]-auth-token`
   - `sb-[project-id]-auth-token-code-verifier` (для PKCE)

### Что смотреть в Network
1. Откройте DevTools → Network
2. При авторизации должны быть запросы к:
   - `https://[your-project].supabase.co/auth/v1/token`
   - `https://[your-project].supabase.co/auth/v1/user`
3. ✅ Все запросы должны возвращать 200 OK

## Известные особенности Safari

### localStorage в Private Mode
В приватном режиме Safari localStorage имеет ограничения, но должен работать для текущей сессии.

### ITP (Intelligent Tracking Prevention)
Safari блокирует третьесторонние cookies, но это не влияет на работу, так как мы используем localStorage.

### Secure Context
Для production с HTTPS все должно работать без проблем.

## Что делать если тесты не проходят

### Если видите AuthError:
1. Проверьте, что используется последняя версия кода
2. Очистите localStorage полностью
3. Очистите cookies
4. Перезагрузите страницу

### Если сессия не сохраняется:
1. Проверьте, что localStorage доступен (не заблокирован настройками)
2. Проверьте размер данных в localStorage
3. Попробуйте в обычном (не приватном) режиме

### Если OAuth не работает:
1. Проверьте настройки OAuth провайдера
2. Проверьте callback URL в настройках Supabase
3. Проверьте консоль на наличие других ошибок

## Чек-лист для полного теста

- [ ] Вход через Email/Password работает
- [ ] OAuth-авторизация работает
- [ ] Сессия сохраняется после перезагрузки
- [ ] Переход между страницами не ломает сессию
- [ ] Выход из системы работает корректно
- [ ] Приватный режим Safari работает
- [ ] Автоматическое обновление токена работает
- [ ] Нет ошибок AuthError в консоли
- [ ] localStorage содержит токены Supabase

## Ссылки на документацию

- [Основное исправление](/docs/SAFARI_AUTH_FIX.md)
- [Supabase Auth Docs](https://supabase.com/docs/guides/auth)
- [Safari Web APIs](https://developer.apple.com/documentation/webkitjs)

## Контакты

Если обнаружите проблемы, создайте issue с:
- Версией Safari
- Шагами для воспроизведения
- Скриншотом консоли
- Скриншотом localStorage

