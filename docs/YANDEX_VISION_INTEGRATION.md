# Интеграция Yandex Vision API для анализа изображений в чате

## Обзор

Данная функциональность добавляет поддержку анализа изображений в чат с помощью Yandex Vision API. Когда пользователь прикрепляет изображение к сообщению, система автоматически:

1. Извлекает текст из изображения (OCR)
2. Классифицирует содержимое изображения
3. Создает детальное описание
4. Передает это описание в YandexGPT для генерации ответа

## Архитектура

### Компоненты

1. **API Endpoint**: `/app/api/analyze-image/route.ts`
   - Принимает URL изображения
   - Загружает изображение
   - Конвертирует в base64
   - Отправляет в Yandex Vision API
   - Возвращает извлеченный текст и классификацию

2. **useChat Hook**: `/hooks/useChat.ts`
   - Перед отправкой сообщения анализирует прикрепленные изображения
   - Обогащает контент сообщения описанием изображений
   - Передает обогащенный контент в YandexGPT

3. **useYandexGPT Hook**: `/hooks/useYandexGPT.ts`
   - Обновлены системные промпты для работы с изображениями
   - Поддержка режима рассуждений с анализом изображений

## Workflow

```
Пользователь прикрепляет изображение
           ↓
FileUploader загружает в Yandex Storage
           ↓
useChat получает URL изображения
           ↓
API /analyze-image анализирует изображение
           ↓
Vision API возвращает:
  - Извлеченный текст (OCR)
  - Классификация содержимого
           ↓
useChat обогащает сообщение описанием
           ↓
YandexGPT получает сообщение с описанием изображения
           ↓
Генерируется ответ с учетом содержимого изображения
```

## Конфигурация

### Переменные окружения

Убедитесь, что в `.env.local` настроены:

```env
YANDEX_API_KEY=your_yandex_api_key
YANDEX_FOLDER_ID=your_yandex_folder_id
```

### Yandex Vision API

Для работы необходимо:
1. Аккаунт в Yandex Cloud
2. Созданный каталог (Folder)
3. API-ключ с правами на Vision API

## Используемые API

### Yandex Vision API

**Endpoint**: `https://vision.api.cloud.yandex.net/vision/v1/batchAnalyze`

**Features используемые в запросе**:
- `TEXT_DETECTION` - распознавание текста (OCR)
  - Поддержка русского и английского языков
- `CLASSIFICATION` - классификация содержимого изображения
  - Определение категорий и объектов на изображении
  - Вероятность для каждой категории

**Формат запроса**:
```json
{
  "folderId": "your_folder_id",
  "analyze_specs": [
    {
      "content": "base64_encoded_image",
      "features": [
        { 
          "type": "TEXT_DETECTION",
          "text_detection_config": {
            "language_codes": ["ru", "en"]
          }
        },
        { "type": "CLASSIFICATION" }
      ]
    }
  ]
}
```

**Формат ответа**:
```json
{
  "results": [
    {
      "results": {
        "textDetection": {
          "pages": [
            {
              "blocks": [
                {
                  "lines": [
                    {
                      "words": [
                        { "text": "слово" }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        "classification": {
          "properties": [
            {
              "name": "category_name",
              "probability": 0.95
            }
          ]
        }
      }
    }
  ]
}
```

## Обработка ошибок

Система обрабатывает следующие типы ошибок:

1. **Ошибки аутентификации**
   - Отсутствие токена
   - Неверный токен
   - Код: 401

2. **Ошибки конфигурации**
   - Отсутствие API ключа
   - Отсутствие Folder ID
   - Код: 500

3. **Ошибки загрузки изображения**
   - Недоступный URL
   - Таймаут загрузки
   - Логируется в консоль, fallback к описанию файла

4. **Ошибки Vision API**
   - Неверный формат изображения
   - Превышен лимит размера
   - Проблемы с API ключом
   - Логируется в консоль, fallback к описанию файла

## Ограничения

### Технические ограничения

1. **Размер изображения**
   - Максимальный размер для Vision API: обычно 8MB
   - Максимальный размер в FileUploader: 10MB
   - Рекомендуется: до 5MB для оптимальной производительности

2. **Поддерживаемые форматы**
   - JPEG, PNG, GIF, WebP
   - Определяется через MIME-type: `image/*`

3. **Количество файлов**
   - Максимум 3 файла на сообщение (настройка в ChatMessageForm)
   - Можно изменить через props FileUploader

### Производительные ограничения

1. **Время обработки**
   - Загрузка изображения: ~1-2 сек
   - Анализ Vision API: ~2-5 сек
   - Общее время: ~3-7 сек перед отправкой в YandexGPT

2. **Токены**
   - Описание изображения добавляет ~50-200 токенов к контексту
   - Учитывается в общем лимите токенов YandexGPT

### Стоимость

- Yandex Vision API - платный сервис
- Стоимость за единицу анализа (проверьте актуальные цены в Yandex Cloud)
- Рекомендуется мониторить использование

## Примеры использования

### Сценарий 1: Распознавание текста

**Пользователь**: *прикрепляет скриншот с кодом*
"Что не так с этим кодом?"

**Система извлекает**:
```
[Изображение: screenshot.png]
Содержимое изображения: code, text, screenshot (85%)
Текст на изображении: "function hello() { consol.log('Hello'); }"
```

**YandexGPT отвечает**:
"Вижу ошибку в коде: вместо `console.log` написано `consol.log` (пропущена буква 'e')."

### Сценарий 2: Анализ графиков

**Пользователь**: *прикрепляет график*
"Какой тренд?"

**Система извлекает**:
```
[Изображение: chart.png]
Содержимое изображения: chart, graph, diagram (92%)
Текст на изображении: "Revenue Q1 2023 - Q4 2023"
```

**YandexGPT отвечает**:
"На графике показана выручка за 4 квартала 2023 года. Наблюдается восходящий тренд..."

### Сценарий 3: Определение объектов

**Пользователь**: *прикрепляет фото животного*
"Что это за порода?"

**Система извлекает**:
```
[Изображение: dog.jpg]
Содержимое изображения: dog, animal, pet (98%)
Текст на изображении не обнаружен
```

**YandexGPT отвечает**:
"На изображении собака. Для точного определения породы нужны дополнительные детали..."

## Расширение функциональности

### Добавление поддержки PDF (будущее развитие)

Для добавления анализа PDF-файлов:

1. Создать endpoint `/api/analyze-pdf`
2. Использовать PDF.js для извлечения текста
3. Интегрировать в useChat аналогично изображениям

### Добавление других Vision features

Yandex Vision API поддерживает дополнительные возможности:
- `FACE_DETECTION` - определение лиц
- `LOGO_DETECTION` - определение логотипов
- `TEXT_DETECTION` с дополнительными языками

Для добавления обновите запрос в `/api/analyze-image/route.ts`:
```typescript
features: [
  { type: 'TEXT_DETECTION' },
  { type: 'CLASSIFICATION' },
  { type: 'FACE_DETECTION' }, // новая функция
]
```

## Тестирование

### Ручное тестирование

1. Откройте чат
2. Прикрепите изображение с текстом
3. Отправьте сообщение с вопросом об изображении
4. Проверьте, что YandexGPT отвечает с учетом содержимого

### Проверка в DevTools

Откройте Network tab и проверьте:
1. Запрос к `/api/analyze-image`
2. Запрос к Yandex Vision API
3. Запрос к `/api/generate-text` с обогащенным контентом

### Логирование

Система логирует:
- Размер загруженного изображения
- Извлеченный текст
- Результаты классификации
- Ошибки на каждом этапе

Проверьте консоль сервера для отладки.

## Troubleshooting

### Изображение не анализируется

1. **Проверьте переменные окружения**
   ```bash
   echo $YANDEX_API_KEY
   echo $YANDEX_FOLDER_ID
   ```

2. **Проверьте права API ключа**
   - Должен иметь доступ к Vision API
   - Проверьте в Yandex Cloud Console

3. **Проверьте размер изображения**
   - Должен быть < 8MB для Vision API

### Неправильное распознавание текста

1. **Качество изображения**
   - Используйте изображения высокого разрешения
   - Избегайте размытых фотографий

2. **Язык текста**
   - По умолчанию поддерживаются RU и EN
   - Для других языков обновите `language_codes`

3. **Ориентация текста**
   - Vision API лучше работает с горизонтальным текстом

### Медленная обработка

1. **Оптимизируйте размер изображения**
   - Сжимайте перед загрузкой
   - Используйте WebP формат

2. **Используйте кэширование**
   - Можно кэшировать результаты анализа в БД
   - Добавить поле `analysis_result` в `chat_messages`

## Мониторинг и метрики

Рекомендуется отслеживать:

1. **Количество запросов к Vision API**
   - Для контроля затрат
   
2. **Время обработки**
   - Среднее время анализа изображения
   
3. **Процент успешных анализов**
   - Соотношение успешных/неуспешных запросов

4. **Размер обогащенного контекста**
   - Влияние на токены YandexGPT

## Безопасность

1. **API ключи**
   - Хранятся только в переменных окружения
   - Не передаются на клиент

2. **Аутентификация**
   - Все запросы проверяют Supabase токен
   - Только авторизованные пользователи могут анализировать изображения

3. **Валидация**
   - Проверка типа файла
   - Ограничение размера
   - Проверка URL

## Связанные файлы

- `/app/api/analyze-image/route.ts` - API endpoint для анализа
- `/hooks/useChat.ts` - интеграция в чат
- `/hooks/useYandexGPT.ts` - обновленные промпты
- `/app/components/chat/FileUploader.tsx` - загрузка файлов
- `/app/components/chat/ChatMessageForm.tsx` - форма сообщений
- `/lib/yandexStorage.ts` - загрузка в Yandex Storage

## Версии

- **v1.0.0** (текущая) - базовая интеграция с Yandex Vision API
  - OCR (распознавание текста)
  - Классификация изображений
  - Интеграция с YandexGPT

## Автор и дата

- Создано: 10 октября 2025
- Последнее обновление: 10 октября 2025

