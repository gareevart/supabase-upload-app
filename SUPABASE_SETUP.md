# Настройка бакета Supabase для загрузки аватаров

Для корректной работы приложения необходимо настроить бакет `avatars` в Supabase с правильными политиками безопасности (RLS).

## Шаги по настройке

### 1. Создание бакета "avatars"

1. Войдите в панель управления Supabase
2. Перейдите в раздел "Storage" в левом меню
3. Нажмите кнопку "Create new bucket"
4. Введите имя бакета: `avatars`
5. Выберите тип доступа: "Public" (если вы хотите, чтобы изображения были доступны публично)
6. Нажмите "Create bucket"

### 2. Настройка политик безопасности (RLS)

После создания бакета необходимо настроить политики безопасности, чтобы разрешить загрузку, чтение и удаление файлов.

#### Политика для загрузки файлов

1. В разделе Storage выберите созданный бакет `avatars`
2. Перейдите на вкладку "Policies"
3. Нажмите "Add Policy"
4. Выберите шаблон "Create custom policy"
5. Заполните форму:
   - Policy name: `Allow uploads`
   - Allowed operations: `INSERT`
   - Policy definition: `true` (или более ограниченное условие, например `auth.role() = 'authenticated'` для авторизованных пользователей)
6. Нажмите "Save policy"

#### Политика для чтения файлов

1. Нажмите "Add Policy" снова
2. Выберите шаблон "Create custom policy"
3. Заполните форму:
   - Policy name: `Allow downloads`
   - Allowed operations: `SELECT`
   - Policy definition: `true` (разрешает всем пользователям просматривать файлы)
4. Нажмите "Save policy"

#### Политика для удаления файлов

1. Нажмите "Add Policy" снова
2. Выберите шаблон "Create custom policy"
3. Заполните форму:
   - Policy name: `Allow deletes`
   - Allowed operations: `DELETE`
   - Policy definition: `true` (или более ограниченное условие, например `auth.role() = 'authenticated'` для авторизованных пользователей)
4. Нажмите "Save policy"

### 3. Проверка настроек

После настройки политик безопасности вы должны иметь возможность:
- Загружать изображения в бакет `avatars`
- Просматривать загруженные изображения
- Удалять изображения из бакета

## Дополнительные настройки

### Ограничение типов файлов

Если вы хотите ограничить типы файлов, которые можно загружать, вы можете изменить политику загрузки:

```sql
(storage.extension(name) = 'jpg' OR 
 storage.extension(name) = 'jpeg' OR 
 storage.extension(name) = 'png' OR 
 storage.extension(name) = 'gif')
```

### Ограничение размера файлов

Для ограничения размера файлов можно использовать:

```sql
(storage.size(name) < 5242880) -- Ограничение в 5MB
```

## Устранение неполадок

Если вы продолжаете получать ошибку "new row violates row-level security policy", убедитесь, что:

1. Бакет `avatars` создан
2. Все необходимые политики настроены правильно
3. Вы используете правильные учетные данные Supabase в вашем приложении

Если проблема не решается, проверьте логи в панели управления Supabase для получения дополнительной информации об ошибке.
